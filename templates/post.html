
{% import 'bootstrap/wtf.html' as wtf %}
{% include 'header.html' %}
        <!-- Page Header-->
        <header class="masthead" style="background-image: url({{ url_for('static', filename='assets/img-stories/'
        + post['main_img']|string)}})">
            <div class="overlay"></div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-md-10 mx-auto">
                        <div class="post-heading">
                            <h1>{{ post['chapter'] }}</h1>
                            <h2 class="subheading"></h2>
                            <span class="meta">
                                Posted by
                                on {{ dt.fromisoformat(post['date']).strftime('%B %d, %Y') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-md-10 mx-auto">
                        <h2 class="section-heading">{{ post['title'] }}</h2>
                        <div class="row">
                         <div class="col-lg-6 col-md-12 mx-auto">
                            <img class="img-fluid" src="{{ url_for('static', filename='assets/img-stories/'
                            + post['img']|string)}}" alt="..." />
                         </div>
                         <div class="col-lg-6 col-md-12 mx-auto">
                            <span class="caption text-muted">{{ post['subtitle'] }}</span>
                         </div>
                        </div>
                            {% set all_rows_story = post["body"].split("\n") %}
                            {% set show_msg_class = ['toast fade hide', 'toast fade show'] %}
                            {% for i in  range(msg_index) %}
                                {% set text = all_rows_story[i] %}
                                {% set msg_id = i %}
                             {% if "{message}" in text: %}
                                    {% if msg_index - 1 == msg_id: %}
                                        {% set show_msg = 'toast fade hide' %}
                                        {% if '{button}' in text %}
                                            {% if '{further}' in text %}
                                            <div id = "{{ msg_id }}" class="col-sm button-msg">
                                                   <a href="{{ url_for('show_post',
                                                index=post.id, msg_id='msg_' + msg_id|string, further=3) }}" class="stretched-link">
                                                    <small class="fontMark"> Дальше >> </small>
                                                   </a>
                                            </div>
                                            {% else %}
                                            {% set buttons = text.replace('{message}', '').replace('{button}', '').split('|') %}
                                            <div id = "{{ msg_id }}" class="container">
                                              <div class="row">
                                                {% for button in buttons %}
                                                <div  class="col-sm button-msg fontMark">
                                                   <a href="{{ url_for('show_post',
                                                index=post.id, msg_id='msg_' + msg_id|string, answer = buttons.index(button)) }}" class="stretched-link">
                                                    {{ button }}
                                                   </a>
                                                </div>
                                                {% endfor %}
                                              </div>
                                            </div>
                                            {% endif %}
                                        {% elif '{answer}' in text %}
                                            {% set answer_msg = text.replace('{message}', '').replace('{answer}', '').split('|')[answer|int] %}
                                            {% if '{media}' in answer_msg: %}
                                                {% set text_media = answer_msg.replace('{media}', '').replace('{end}', '').split(';') %}
                                                <div id="{{ msg_id }}" class="card card-answer" style="width: 24rem; margin: auto;">
                                                    {% set link = text_media[0].replace(' ','') %}
                                                  {% if 'http' in  link %}
                                                        <img src="{{link}}" class="card-img-top" alt="...">
                                                   {% else %}
                                                         <img src="{{url_for('static', filename='assets/img-stories/'
                                                        + link|string)}}" class="card-img-top" alt="...">
                                                   {% endif %}
                                                  <div class="card-body">
                                                    {% if '{end}' in answer_msg %}
                                                    <h5 class="card-title">Конец Путешествия</h5>
                                                     {% endif %}
                                                    <p class="card-text">
                                                      {{text_media[1]|safe }}
                                                    </p>
                                                  </div>
                                                </div>
                                                <br>
                                            {% else %}
                                                <div id="{{ msg_id }}" class="card card-answer" style="width: 24rem; margin: auto;">
                                                  <div class="card-body">
                                                    {% if '{end}' in answer_msg %}
                                                    <h5 class="card-title">Конец Путешествия</h5>
                                                     {% endif %}
                                                    <p class="card-text">
                                                      {{answer_msg.replace('{end}', '')|safe }}
                                                    </p>
                                                  </div>
                                                </div>
                                                <br>
                                            {% endif %}
                                            {% if '{end}' in answer_msg %}
                                                {% set further = 0 %}
                                            {% else %}
                                                {% set further = 1 %}
                                            {% endif %}
                                            <div id = "{{ msg_id }}" class="col-sm button-msg">
                                                   <a href="{{ url_for('show_post',
                                                index=post.id, msg_id='msg_' + msg_id|string, further=further) }}" class="stretched-link">
                                                    <small class="fontMark"> Дальше >> </small>
                                                   </a>
                                            </div>
                                        {% else %}
                                            {% set show_msg = 'toast fade show' %}
                                        {% endif %}
                                    {% else %}
                                        {% set show_msg = 'toast fade hide' %}
                                    {% endif %}
                                    {% set split_text = text.replace('{message}','').split(';') %}
                                <div id="{{ msg_id }}" class="{{ show_msg }}"
                                     role="alert" aria-live="assertive" aria-atomic="true">
                                    <div class="toast-header">
                                        <img class="bd-placeholder-img rounded mr-2" width="20" height="20"
                                             src="{{ url_for('static',
                                             filename='assets/img-stories/' + split_text[0].replace(' ','')) }}"
                                             role="img" aria-label=" :
                                            " preserveAspectRatio="xMidYMid slice" focusable="false">
                                            <title></title>
                                            <rect width="100%" height="100%" fill="#007aff"></rect>
                                            <text x="50%" y="50%" fill="#dee2e6" dy=".3em"> </text>
                                        </img>
                                        <strong class="mr-auto">{{split_text[1]}}</strong>   <small>продолжим историю</small>

                                        <a type="button" class="ml-2 mb-1 close" data-dismiss="toast"
                                                aria-label="Close" href="{{ url_for('show_post',
                                                index=post.id, msg_id='msg_' + msg_id |string) }}">
                                            <span aria-hidden="true">>></span>
                                        </a>
                                    </div>
                                    <div class="toast-body">
                                        {{ split_text[2]|safe }}
                                     </div>
                                </div>
                            {% elif '{img}' in text: %}
                                {% set link = text.replace('{img}', '').replace(' ', '').replace('\r', '') %}
                                <div id="{{ msg_id }}" class="text-center">
                                {% if 'http' in  link %}
                                        <img src="{{link}}" class="rounded" alt="...">
                                {% else %}
                                         <img src="{{url_for('static', filename='assets/img-stories/'
                                        + link|string)}}" class="rounded" alt="...">
                               {% endif %}
                                </div>
                                <br>
                            {% elif '{iframe}' in text: %}
                                {% set link_iframe = text.replace('{iframe}', '') %}
                                <div id="{{ msg_id }}" class="embed-responsive embed-responsive-16by9">
                                        <iframe class="embed-responsive-item"
                                                src="{{ link_iframe }}?&start=0&loop=1&controls=0&showinfo=0&playlist={{link_iframe.split('/')[-1] }}"
                                                frameborder="0" allowfullscreen >
                                        </iframe>
                                </div>
                                <br>
                            {% elif '{media}' in text: %}
                                {% set text_media = text.replace('{media}', '').split(';') %}
                                <div id="{{ msg_id }}" class="card card-answer" style="width: 24rem; margin: auto;">
                                    {% set link = text_media[0].replace(' ','') %}
                                  {% if 'http' in  link %}
                                        <img src="{{link}}" class="card-img-top" alt="...">
                                   {% else %}
                                         <img src="{{url_for('static', filename='assets/img-stories/'
                                        + link|string)}}" class="card-img-top" alt="...">
                                   {% endif %}
                                  <div class="card-body">
                                    {% if '{title}' in text_media[1] %}
                                    <h5 class="card-title">{{text_media[1].replace('{title}', '')}}</h5>
                                          <p class="card-text">
                                                {{text_media[2]|safe }}
                                          </p>
                                     {% else %}
                                        <p class="card-text">
                                          {{text_media[1]|safe }}
                                        </p>
                                      {% endif %}
                                  </div>
                                </div>
                                <br>

                            {% else %}
                             <div id="{{ msg_id }}">
                                 {% if '<small' in text %}
                                 <p style="line-height: 1.0;">{{ text|safe }}</p>
                                 {% else %}
                                 <p>{{ text|safe }}</p>
                                 {% endif %}
                             </div>
                            {% endif %}
                            {% endfor %}
                    </div>
                </div>
            </div>
        </article>
        <hr />
        <!--           Comments Area -->
        {% if current_user.is_authenticated %}
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-10 mx-auto">
              {{ wtf.quick_form(form, novalidate=True,
                button_map={"submit": "primary"}) }}

            </div>
          </div>
        </div>
        {% else %}
        <div class="container">
            <span class="date sub-text"> For comment story need to
                <a href="{{ url_for('login', page='post/' + post.id|string) }}" style="color: green;">Login</a> </span>
        </div>
        {% endif %}
          <div class="col-lg-8 col-md-10 mx-auto comment">
              <ul class="commentList">
                {% for comment in post.comments[::-1] %}
                <li>
                    <div class="commenterImage">
                      <img src="{{ comment.comment_author.email | gravatar }}"/>
                    </div>
                    <div class="commentText">
                      <p style="font-size: 1.0rem; font-family: 'Open Sans';">{{comment.text|safe}}
                    {% if current_user.id == 1 or comment.comment_author.id == current_user.id %}
                        <a href="{{url_for('delete_comment', comment_id=comment.id, index=post.id) }}"
                           style="color: red; text-decoration: none; " title="delete comment">✘</a>
                    {% endif %}
                       </p>
                      <span class="date sub-text">{{comment.comment_author.name}}</span>
                    </div>

                </li>
                {% endfor %}
              </ul>
            </div>
<!--         Footer-->
 {% include 'footer.html' %}